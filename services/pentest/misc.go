// Package pentest implements a Service to penetrate a server and crate reports of the result
package pentest

import (
	"crypto/tls"
	"encoding/xml"
	"fmt"
	"strings"

	log "github.com/sirupsen/logrus"
)

// start a task in OpenVAS
func (s *Service) startTask(taskID string) (string, string, string) {
	var xmlMsg string
	xmlMsg = xmlMsg + fmt.Sprintf("<authenticate><credentials><username>%s</username><password>%s</password></credentials></authenticate>", s.OpenVASUsername, s.OpenVASPassword)
	xmlMsg = xmlMsg + fmt.Sprintf("<start_task task_id=\"%s\"/>", taskID)
	message := s.sendSocket(xmlMsg)

	var res StartTaskResponse

	err := xml.Unmarshal([]byte("<StartTaskResponse>"+message+"</StartTaskResponse>"), &res)
	if err != nil {
		return "", "", "400"
	}

	return res.StartTask.ReportID, res.StartTask.Status, res.StartTask.StatusText
}

// create a task in OpenVAS
func (s *Service) createTask(name, scanConfigID, targetID string) (string, string) {
	var xmlMsg string
	xmlMsg = xmlMsg + fmt.Sprintf("<authenticate><credentials><username>%s</username><password>%s</password></credentials></authenticate>", s.OpenVASUsername, s.OpenVASPassword)
	xmlMsg = xmlMsg + fmt.Sprintf("<create_task><name>%s</name><config id=\"%s\"/><target id=\"%s\"/></create_task>", name, scanConfigID, targetID)
	message := s.sendSocket(xmlMsg)

	var res CreateTaskResponse

	err := xml.Unmarshal([]byte("<CreateTaskResponse>"+message+"</CreateTaskResponse>"), &res)
	if err != nil {
		return "", "400"
	}

	return res.CreateTask.ID, res.CreateTask.Status
}

// get out a report
func (s *Service) getReportInFormat(reportID, formatID string) (string, string, string, string) {
	var xmlMsg string
	xmlMsg = xmlMsg + fmt.Sprintf("<authenticate><credentials><username>%s</username><password>%s</password></credentials></authenticate>", s.OpenVASUsername, s.OpenVASPassword)
	xmlMsg = xmlMsg + fmt.Sprintf("<get_reports report_id=\"%s\" format_id=\"%s\"></get reports>", reportID, formatID)
	message := s.sendSocket(xmlMsg)

	var res GetReportsResponseInFormat

	err := xml.Unmarshal([]byte("<GetReportsResponse>"+message+"</GetReportsResponse>"), &res)
	if err != nil {
		return "", "", "", "400"
	}

	return res.GetReportsResponse.Report.Data, res.GetReportsResponse.Report.ContentType, res.GetReportsResponse.Report.Extension, res.GetReportsResponse.Status
}

// get out a report
func (s *Service) getReport(reportID string) (string, string) {
	var xmlMsg string
	xmlMsg = xmlMsg + fmt.Sprintf("<authenticate><credentials><username>%s</username><password>%s</password></credentials></authenticate>", s.OpenVASUsername, s.OpenVASPassword)
	xmlMsg = xmlMsg + fmt.Sprintf("<get_reports report_id=\"%s\"><filter levels=\"hmlgd\"/></get_reports>", reportID)
	message := s.sendSocket(xmlMsg)

	var res GetReportsResponse

	err := xml.Unmarshal([]byte("<GetReportsResponse>"+message+"</GetReportsResponse>"), &res)
	if err != nil {
		return "", "400"
	}
	return res.GetReportsResponse.Report.Report.ScanRunStatus, res.GetReportsResponse.Status
}

// get out all scan config id's
func (s *Service) getReportFormatIDs() (GetReportFormatsResponse, string, string) {
	var xmlMsg string
	xmlMsg = xmlMsg + fmt.Sprintf("<authenticate><credentials><username>%s</username><password>%s</password></credentials></authenticate>", s.OpenVASUsername, s.OpenVASPassword)
	xmlMsg = xmlMsg + fmt.Sprintf("<get_report_formats></get_report_formats>")
	message := s.sendSocket(xmlMsg)
	log.Info(message)
	var res GetReportFormatsResponse

	err := xml.Unmarshal([]byte("<GetReportFormatsResponse>"+message+"</GetReportFormatsResponse>"), &res)
	if err != nil {
		return res, "400", res.GetReportFormatsResponse.StatusText
	}

	return res, res.GetReportFormatsResponse.Status, res.GetReportFormatsResponse.StatusText
}

// get out all scan config id's
func (s *Service) getScanConfigIDs() (GetConfigsResponse, string) {
	var xmlMsg string
	xmlMsg = xmlMsg + fmt.Sprintf("<authenticate><credentials><username>%s</username><password>%s</password></credentials></authenticate>", s.OpenVASUsername, s.OpenVASPassword)
	xmlMsg = xmlMsg + fmt.Sprintf("<get_configs/>")
	message := s.sendSocket(xmlMsg)

	var res GetConfigsResponse

	err := xml.Unmarshal([]byte("<GetConfigsResponse>"+message+"</GetConfigsResponse>"), &res)
	if err != nil {
		return res, "400"
	}

	return res, res.GetConfigsResponse.Status
}

// create a scan target in OpenVAS
func (s *Service) createTarget(name, target string) (string, string, string) {
	var xmlMsg string
	xmlMsg = xmlMsg + fmt.Sprintf("<authenticate><credentials><username>%s</username><password>%s</password></credentials></authenticate>", s.OpenVASUsername, s.OpenVASPassword)
	xmlMsg = xmlMsg + fmt.Sprintf("<create_target><name>%s</name><hosts>%s</hosts><port_range>1-65535</port_range></create_target>", name, target)
	message := s.sendSocket(xmlMsg)

	var res CreateTargetResponse

	err := xml.Unmarshal([]byte("<CreateTargetResponse>"+message+"</CreateTargetResponse>"), &res)
	if err != nil {
		log.Error("Service: Pentest: Create Target", err)
		return "", "400", res.CreateTarget.StatusText
	}
	return res.CreateTarget.ID, res.CreateTarget.Status, res.CreateTarget.StatusText
}

// Authenticate against OpenVAS
func (s *Service) omgAuthentication(userID string) string {
	xmlMsg := fmt.Sprintf("<authenticate><credentials><username>%s</username><password>%s</password></credentials></authenticate>", s.OpenVASUsername, s.OpenVASPassword)
	message := s.sendSocket(xmlMsg)
	if message == "-1" {
		return "400"
	}

	var res AuthenticateResponse
	err := xml.Unmarshal([]byte(message), &res)
	if err != nil {
		return "400"
	}
	return res.Status
}

// Function to send xml command to the openvas ssl socket
func (s *Service) sendSocket(message string) string {
	stopCharacter := "\r\n\r\n"
	addr := strings.Join([]string{s.OpenVASIP, s.OpenVASPort}, ":")
	conn, err := tls.Dial("tcp", addr, &tls.Config{InsecureSkipVerify: true})

	defer conn.Close()
	if err != nil {
		log.Error("Service: Pentest:", err)
	}

	conn.Write([]byte(message))
	conn.Write([]byte(stopCharacter))

	buff := make([]byte, 1024)
	n := 1024
	var line string
	for n > 0 && n == 1024 {
		n, _ = conn.Read(buff)
		line = line + fmt.Sprintf("%s", buff[:n])
	}
	return line
}
